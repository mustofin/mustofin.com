<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portofolio | Misbakhul Mustofin</title>
    <link rel="icon" type="image/x-icon" href="https://media.mayar.id/images/0702dec7-5a60-4897-a6ec-69396fde8bc1.jpeg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        button.active {
            background-color: #2563eb;
            color: white;
        }
        button.active:hover {
            background-color: #2563eb;
        }
        .portfolio-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .portfolio-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .portfolio-item:hover .portfolio-overlay {
            opacity: 1;
        }
        .portfolio-overlay {
            background: rgba(37, 99, 235, 0.9);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans antialiased text-gray-800 bg-white">
    <div id="navbar-placeholder"></div>

    <main class="pt-24 pb-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">Portofolio</h1>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">Kumpulan proyek dan pencapaian profesional saya</p>
            </div>

            <div class="flex justify-center mb-12">
                <div id="portfolio-filter-container" class="inline-flex rounded-md shadow-sm flex-wrap justify-center">
                    </div>
            </div>

            <div id="portfolio-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="scripts.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Konfigurasi ---
            // const apiUrl = 'https://script.google.com/macros/s/AKfycbzuQ2vg0P-tCJNm6uGQvuzwFHkoTqYTik6yXcl_xLKtvV-MQXZYeISr2dp1A4RBnf-1ww/exec';
            const apiUrl = 'https://script.google.com/macros/s/AKfycby7q70FGyV5P1ouhnHBHEl6z4W3kD50q9J6xW_jfO_j0zVZucQEWxE7SknmO0vl6S7i8g/exec?page=portfolio';
            const CACHE_KEY = 'portfolioDataCache';
            const CACHE_DURATION_MS = 6 * 60 * 60 * 1000; // 6 Jam

            const grid = document.getElementById('portfolio-grid');
            const filterContainer = document.getElementById('portfolio-filter-container');
            let fullPortfolioData = [];

            const categoryColors = {
                project: 'bg-blue-500',
                teaching: 'bg-green-500',
                speaking: 'bg-purple-500',
                event: 'bg-yellow-500',
                research: 'bg-red-500',
                apps: 'bg-indigo-500',
            };

            // Fungsi untuk menginisialisasi halaman dengan data
            function initializePage(data) {
                fullPortfolioData = data;
                sessionStorage.setItem('portfolioData', JSON.stringify(fullPortfolioData)); // Simpan untuk halaman detail

                renderCards(fullPortfolioData);
                generateAndSetupFilters(fullPortfolioData);
                feather.replace();
            }
            
            // Coba ambil data dari cache
            try {
                const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
                if (cached && (new Date().getTime() - cached.timestamp < CACHE_DURATION_MS)) {
                    console.log("Memuat data dari cache yang valid.");
                    initializePage(cached.data);
                } else {
                    // Cache tidak ada atau sudah kedaluwarsa, ambil dari API
                    fetchFromAPI();
                }
            } catch (e) {
                // Jika ada error saat parsing cache, ambil dari API
                fetchFromAPI();
            }

            function fetchFromAPI() {
                console.log("Cache kosong atau kedaluwarsa. Mengambil data dari API.");
                grid.innerHTML = `<div class="loader-container col-span-3"><div class="loader"></div><p class="text-center text-gray-500">Memuat portofolio...</p></div>`;

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(response => {
                        if (response.status === 'success' && response.data.length > 0) {
                            // Simpan data dan timestamp ke cache
                            const itemToCache = {
                                data: response.data,
                                timestamp: new Date().getTime()
                            };
                            localStorage.setItem(CACHE_KEY, JSON.stringify(itemToCache));
                            
                            // Inisialisasi halaman dengan data baru
                            initializePage(response.data);
                        } else {
                            grid.innerHTML = '<p class="col-span-3 text-center text-gray-500">Tidak ada data portofolio untuk ditampilkan.</p>';
                            filterContainer.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching portfolio data:', error);
                        grid.innerHTML = '<p class="col-span-3 text-center text-red-500">Gagal memuat data. Silakan coba muat ulang halaman.</p>';
                        filterContainer.style.display = 'none';
                    });
            }

            function renderCards(data) {
                grid.innerHTML = '';
                data.forEach(item => {
                    const cardHtml = `
                        <div class="portfolio-item rounded-xl overflow-hidden shadow-md" data-category="${item.type}" data-id="${item.id}">
                            <div class="h-48 overflow-hidden">
                                <img class="w-full h-full object-cover" src="${item.image_cover}" alt="${item.title}">
                            </div>
                            <div class="p-6">
                                <span class="inline-block px-2 py-1 text-xs font-semibold text-white rounded-full mb-2 ${categoryColors[item.type] || 'bg-gray-500'}">
                                    ${item.category_label}
                                </span>
                                <h3 class="text-xl font-bold text-gray-900 mb-2">${item.title}</h3>
                                <p class="text-gray-600 mb-4">${item.description_short}</p>
                                <span class="text-blue-600 font-medium inline-flex items-center">
                                    Lihat Detail <i data-feather="arrow-right" class="ml-1 w-4 h-4"></i>
                                </span>
                            </div>
   
                        </div>
                    `;
                    grid.insertAdjacentHTML('beforeend', cardHtml);
                });

                document.querySelectorAll('.portfolio-item').forEach(card => {
                    card.addEventListener('click', () => {
                        const itemId = card.dataset.id;
                        const selectedItem = fullPortfolioData.find(item => item.id == itemId);
                        if (selectedItem) {
                            sessionStorage.setItem('selectedPortfolioItem', JSON.stringify(selectedItem));
                            window.location.href = `portfolio-detail.html?id=${itemId}`;
                        }
                    });
                });
            }

            function generateAndSetupFilters(data) {
                // (Fungsi ini tetap sama)
                const categories = new Map([['all', 'Semua']]);
                data.forEach(item => {
                    if (item.type && item.category_label && !categories.has(item.type)) {
                        categories.set(item.type, item.category_label);
                    }
                });

                let buttonsHtml = '';
                const categoryArray = Array.from(categories.entries());

                categoryArray.forEach(([type, label], index) => {
                    const isFirst = index === 0;
                    const isLast = index === categoryArray.length - 1;
                    let buttonClasses = "px-4 py-2 text-sm font-medium border-t border-b border-gray-300 hover:bg-gray-50 focus:z-10 focus:outline-none";
                    if (isFirst) buttonClasses += " rounded-l-lg border-l";
                    if (isLast) buttonClasses += " rounded-r-lg border-r";
                    buttonsHtml += `<button type="button" class="${buttonClasses}" data-filter="${type}">${label}</button>`;
                });
                
                filterContainer.innerHTML = buttonsHtml;
                
                const filterButtons = filterContainer.querySelectorAll('button');
                filterContainer.querySelector('button[data-filter="all"]').classList.add('active');

                filterButtons.forEach(button => {
                    button.addEventListener('click', function(event) {
                        event.stopPropagation();
                        filterButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                        const filter = this.getAttribute('data-filter');
                        document.querySelectorAll('.portfolio-item').forEach(item => {
                            item.style.display = (filter === 'all' || item.dataset.category === filter) ? 'block' : 'none';
                        });
                    });
                });
            }
        });
    </script>
</body>
</html>